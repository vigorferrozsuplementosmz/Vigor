<!DOCTYPE html>
<html lang="pt-MZ">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIGOR FERROZ | Ultra Suite AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #0b0f12; color: white; scroll-behavior: smooth; font-family: 'Inter', sans-serif; }
        .neon-text { color: #39ff14; text-shadow: 0 0 10px rgba(57, 255, 20, 0.5); }
        .admin-hidden { display: none !important; }
        .bg-card { background-color: #161b22; }
        .input-dark { background-color: #0d1117; border: 1px solid #30363d; color: white; }
        
        .status-confirmado { background-color: #22c55e; color: white; }
        .status-entregue { background-color: #3b82f6; color: white; }
        .status-pendente { background-color: #eab308; color: black; }
        .status-cancelado { background-color: #ef4444; color: white; }
        
        .tab-active { border-bottom: 3px solid #39ff14; color: #39ff14; font-weight: 900; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* AI Styles */
        .ai-glow { box-shadow: 0 0 15px rgba(168, 85, 247, 0.4); border: 1px solid rgba(168, 85, 247, 0.5); }
        .ai-text { color: #a855f7; }
        .loading-shimmer { background: linear-gradient(90deg, #161b22 25%, #1d232c 50%, #161b22 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body>
    <!-- INTERFACE CLIENTE -->
    <div id="client-site">
        <header class="py-10 text-center border-b border-gray-800 bg-black/30 sticky top-0 z-50 backdrop-blur-sm">
            <h1 class="text-5xl font-black neon-text uppercase tracking-tighter italic">VIGOR FERROZ</h1>
            <p class="text-gray-400 mt-2 font-medium">Pot√™ncia M√°xima em Mo√ßambique</p>
        </header>

        <main class="max-w-4xl mx-auto p-4 py-8">
            <div class="text-center mb-8">
                <img id="fotoProduto" src="https://via.placeholder.com/400?text=Vigor+Ferroz" class="mx-auto rounded-[2rem] border-2 border-[#39ff14]/30 shadow-2xl max-w-[300px]">
            </div>

            <section class="bg-card p-8 rounded-[2.5rem] border border-gray-800 shadow-2xl mb-8">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-black text-[#39ff14] uppercase italic">Encomendar Agora</h2>
                    <p class="text-red-500 font-bold animate-pulse text-xs mt-2 uppercase">‚ö†Ô∏è STOCK LIMITADO: <span id="urgenciaStock">--</span> UNIDADES!</p>
                </div>
                
                <form id="orderForm" autocomplete="off" class="grid grid-cols-1 md:grid-cols-2 gap-5 text-left">
                    <input type="text" id="nome" placeholder="Nome Completo" class="w-full p-4 input-dark rounded-2xl outline-none" required>
                    <input type="number" id="contacto" placeholder="Telem√≥vel" class="w-full p-4 input-dark rounded-2xl outline-none" required>
                    <select id="provincia" class="w-full p-4 input-dark rounded-2xl outline-none" required>
                        <option value="">Prov√≠ncia...</option>
                        <option>Maputo Cidade</option><option>Maputo Prov√≠ncia</option><option>Gaza</option>
                        <option>Inhambane</option><option>Sofala</option><option>Manica</option>
                        <option>Tete</option><option>Zamb√©zia</option><option>Nampula</option>
                        <option>Niassa</option><option>Cabo Delgado</option>
                    </select>
                    <input type="text" id="bairro" placeholder="Bairro" class="w-full p-4 input-dark rounded-2xl outline-none" required>
                    
                    <div class="md:col-span-2">
                        <select id="horario" class="w-full p-4 input-dark rounded-2xl outline-none" required>
                            <option value="">Per√≠odo de Entrega...</option>
                            <option>Manh√£ (08h - 12h)</option>
                            <option>Tarde (12h - 17h)</option>
                        </select>
                    </div>

                    <div class="md:col-span-2 text-center pt-6">
                        <div class="text-6xl font-black neon-text mb-4 italic tracking-tighter"><span id="precoExibicao">---</span><span class="text-2xl ml-1">MT</span></div>
                        <button type="submit" id="btnSubmit" class="w-full bg-[#39ff14] text-black font-extrabold py-6 rounded-3xl text-2xl uppercase hover:brightness-110 active:scale-95 transition-all shadow-[0_10px_30px_rgba(57,255,20,0.3)]">
                            Finalizar Pedido
                        </button>
                    </div>
                </form>
            </section>
        </main>
        
        <footer class="text-center p-12 border-t border-gray-900">
            <button onclick="showAdmin()" class="text-gray-900 hover:text-[#39ff14] text-[10px] font-bold uppercase transition">Admin Panel</button>
        </footer>
    </div>

    <!-- √ÅREA ADMINISTRATIVA -->
    <div id="admin-area" class="admin-hidden p-4 md:p-8 min-h-screen bg-[#020617]">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-3xl font-black text-[#39ff14] uppercase italic tracking-tighter">Gest√£o Master</h2>
                    <div id="visitor-alert" class="hidden items-center gap-2 text-[10px] text-white bg-blue-600 px-3 py-1 rounded-full mt-2 font-bold animate-pulse uppercase">
                        <i class="fas fa-signal"></i> Visitante no Site
                    </div>
                </div>
                <button onclick="hideAdmin()" class="bg-red-600/20 text-red-500 px-6 py-2 rounded-xl font-black text-xs border border-red-600/30 uppercase">Sair</button>
            </div>

            <!-- Dashboard -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
                <div class="bg-card p-6 rounded-[2rem] border border-gray-800">
                    <label class="text-[10px] uppercase text-gray-500 font-black">Faturamento Bruto (Entregues)</label>
                    <p class="text-4xl font-black text-blue-400 mt-2 italic" id="totalReceita">0 MT</p>
                </div>
                <div class="bg-card p-6 rounded-[2rem] border border-gray-800">
                    <label class="text-[10px] uppercase text-gray-500 font-black">Performance Semanal (Tudo)</label>
                    <div class="h-28 mt-2">
                        <canvas id="vendasChart"></canvas>
                    </div>
                </div>
                <div class="bg-card p-6 rounded-[2rem] border border-gray-800 flex items-center justify-between">
                    <div>
                        <label class="text-[10px] uppercase text-gray-500 font-black">Stock Real (Armaz√©m)</label>
                        <p class="text-4xl font-black text-white mt-2" id="dashStockReal">--</p>
                    </div>
                    <i class="fas fa-warehouse text-4xl text-gray-800"></i>
                </div>
            </div>

            <!-- AI Insight Section -->
            <div class="mb-8">
                <button onclick="gerarRelatorioAI()" id="aiReportBtn" class="flex items-center gap-2 bg-purple-600/20 text-purple-400 border border-purple-500/30 px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-wider hover:bg-purple-600/30 transition-all">
                    <i class="fas fa-magic"></i> Analista de Vendas ‚ú®
                </button>
                <div id="aiResponseContainer" class="hidden mt-4 p-6 bg-purple-950/20 border border-purple-500/20 rounded-[2rem] text-xs leading-relaxed text-purple-100 italic">
                    <div id="aiResponseText"></div>
                </div>
            </div>

            <!-- Navega√ß√£o -->
            <div class="flex gap-8 mb-6 border-b border-gray-800 px-2">
                <button onclick="switchTab('entregas')" id="tab-entregas" class="pb-3 text-xs uppercase font-black transition tab-active">Pedidos & Log√≠stica</button>
                <button onclick="switchTab('stock')" id="tab-stock" class="pb-3 text-xs uppercase font-black transition text-gray-500">Stock & Telegram</button>
            </div>

            <!-- ABA ENTREGAS -->
            <div id="content-entregas" class="tab-content active">
                <div class="bg-white rounded-[2rem] overflow-hidden shadow-2xl overflow-x-auto">
                    <table class="w-full text-left min-w-[1000px]">
                        <thead class="bg-gray-100 border-b border-gray-200">
                            <tr class="text-[10px] font-black uppercase text-gray-400 italic">
                                <th class="p-5">Cliente</th>
                                <th class="p-5">Local / Hora</th>
                                <th class="p-5">Fase do Pedido</th>
                                <th class="p-5">Notas / Justificativa</th>
                                <th class="p-5 text-center">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="adminTable" class="text-sm text-black font-medium"></tbody>
                    </table>
                </div>
            </div>

            <!-- ABA STOCK & TELEGRAM -->
            <div id="content-stock" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-card p-8 rounded-[2rem] border border-gray-800">
                        <h3 class="text-xl font-black text-[#39ff14] mb-6 uppercase">Gest√£o Independente de Stocks</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="text-[9px] uppercase text-gray-400 font-bold ml-1">Stock de Marketing (O que o cliente v√™)</label>
                                <input type="number" id="admStockMarketing" class="w-full p-4 input-dark rounded-2xl outline-none mt-1">
                            </div>
                            <div>
                                <label class="text-[9px] uppercase text-gray-400 font-bold ml-1">Stock Real (Controlo de Armaz√©m)</label>
                                <input type="number" id="admStockReal" class="w-full p-4 input-dark rounded-2xl outline-none mt-1">
                            </div>
                            <div>
                                <label class="text-[9px] uppercase text-gray-400 font-bold ml-1">Pre√ßo do Produto (MT)</label>
                                <input type="number" id="admPreco" class="w-full p-4 input-dark rounded-2xl outline-none mt-1">
                            </div>
                            <input type="text" id="admImg" placeholder="Link da Imagem" class="w-full p-4 input-dark rounded-2xl outline-none">
                            <button onclick="salvarTudo()" class="w-full bg-[#39ff14] text-black font-black py-5 rounded-2xl uppercase shadow-lg mb-4">Salvar Configura√ß√µes</button>
                            
                            <!-- AI Marketing Helper -->
                            <div class="pt-4 border-t border-gray-800">
                                <button onclick="gerarCopyMarketing()" id="aiCopyBtn" class="w-full bg-purple-600/20 text-purple-400 border border-purple-500/30 py-4 rounded-2xl text-[10px] font-black uppercase tracking-wider hover:bg-purple-600/30 transition-all">
                                    <i class="fas fa-bullhorn"></i> Gerar Promo√ß√£o Criativa ‚ú®
                                </button>
                                <div id="aiCopyResponse" class="hidden mt-3 p-4 bg-purple-950/30 rounded-xl text-[11px] text-purple-200 border border-purple-500/20"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-card p-8 rounded-[2rem] border border-gray-800">
                        <h3 class="text-xl font-black text-blue-400 mb-6 uppercase">Alertas Telegram</h3>
                        <div class="space-y-4">
                            <input type="text" id="telBot" placeholder="Token do Bot" class="w-full p-4 input-dark rounded-2xl outline-none text-xs">
                            <input type="text" id="telChat" placeholder="ID do seu Chat" class="w-full p-4 input-dark rounded-2xl outline-none text-xs">
                            <button onclick="salvarTelegram()" class="w-full bg-blue-600 text-white font-black py-5 rounded-2xl uppercase text-xs">Salvar Configura√ß√£o Telegram</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const apiKey = ""; // API Key provided by environment
        const firebaseConfig = {
            apiKey: "AIzaSyBBNopVEwgMdmnZDELAdSIAoLOW4tLEyZ8",
            databaseURL: "https://vigorferroz-default-rtdb.firebaseio.com",
            projectId: "vigorferroz",
            appId: "1:263350995456:web:a1b3e080a6bf0de9dc26e5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // GEMINI API UTILS
        async function callGemini(prompt, systemPrompt = "") {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Erro ao processar IA.";
                } catch (e) {
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
            }
            return "Falha na conex√£o com a IA ap√≥s v√°rias tentativas.";
        }

        // AI FEATURE: SALES ANALYST
        async function gerarRelatorioAI() {
            const btn = document.getElementById('aiReportBtn');
            const container = document.getElementById('aiResponseContainer');
            const textEl = document.getElementById('aiResponseText');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analisando Dados...';
            container.classList.remove('hidden');
            textEl.innerHTML = '<div class="h-4 w-3/4 loading-shimmer rounded mb-2"></div><div class="h-4 w-1/2 loading-shimmer rounded"></div>';

            const snapshot = await db.ref('pedidos').once('value');
            const pedidos = [];
            snapshot.forEach(c => pedidos.push(c.val()));

            const prompt = `Analise estes dados de pedidos do meu neg√≥cio "Vigor Ferroz": ${JSON.stringify(pedidos)}. 
            Forne√ßa um relat√≥rio ultra-curto (m√°ximo 3 frases) em portugu√™s de Mo√ßambique com um tom motivador e estrat√©gico. 
            Destaque qual prov√≠ncia est√° a comprar mais e d√™ uma dica de neg√≥cio.`;

            const res = await callGemini(prompt, "Aja como um analista de neg√≥cios experiente focado no mercado de Mo√ßambique.");
            textEl.innerText = res;
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-magic"></i> Analista de Vendas ‚ú®';
        }

        // AI FEATURE: MARKETING HELPER
        async function gerarCopyMarketing() {
            const btn = document.getElementById('aiCopyBtn');
            const responseEl = document.getElementById('aiCopyResponse');
            const stock = document.getElementById('admStockReal').value;
            const preco = document.getElementById('admPreco').value;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando Copy...';
            
            const prompt = `Crie uma mensagem curta de marketing para WhatsApp para vender o "Vigor Ferroz". 
            Pre√ßo: ${preco} MT. Stock real dispon√≠vel: ${stock} unidades. 
            Use um tom persuasivo mo√ßambicano, inclua emojis e foque na urg√™ncia.`;

            const res = await callGemini(prompt, "√âs um copywriter especialista em vendas diretas em Mo√ßambique.");
            responseEl.innerText = res;
            responseEl.classList.remove('hidden');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-bullhorn"></i> Gerar Promo√ß√£o Criativa ‚ú®';
        }

        // TELEGRAM
        let telegramConfig = { bot: "", chat: "" };
        db.ref('telegram').on('value', snap => { if(snap.val()) telegramConfig = snap.val(); });

        async function notifyTelegram(msg) {
            if(!telegramConfig.bot || !telegramConfig.chat) return;
            const url = `https://api.telegram.org/bot${telegramConfig.bot}/sendMessage?chat_id=${telegramConfig.chat}&text=${encodeURIComponent(msg)}`;
            try { fetch(url); } catch(e) {}
        }

        async function salvarTelegram() {
            const b = document.getElementById('telBot').value;
            const c = document.getElementById('telChat').value;
            await db.ref('telegram').set({ bot: b, chat: c });
            alert("Telegram configurado!");
        }

        // VISITAS
        db.ref('visitas_activas/count').on('value', snap => {
            const count = snap.val() || 0;
            const alertBox = document.getElementById('visitor-alert');
            if(count > 0) alertBox.classList.remove('hidden');
            else alertBox.classList.add('hidden');
        });
        const visitorRef = db.ref('visitas_activas/count');
        visitorRef.transaction(c => (c || 0) + 1);
        window.addEventListener('beforeunload', () => visitorRef.transaction(c => (c > 0 ? c - 1 : 0)));

        // CONFIG & STOCK
        db.ref('configuracao').on('value', snap => {
            const c = snap.val() || {};
            document.getElementById('urgenciaStock').innerText = c.stockMarketing || 0;
            document.getElementById('dashStockReal').innerText = c.stockReal || 0;
            document.getElementById('precoExibicao').innerText = (c.preco || 0).toLocaleString();
            document.getElementById('fotoProduto').src = c.imagem || "https://via.placeholder.com/400";

            if(!document.activeElement.id.startsWith('adm')) {
                document.getElementById('admStockMarketing').value = c.stockMarketing || 0;
                document.getElementById('admStockReal').value = c.stockReal || 0;
                document.getElementById('admPreco').value = c.preco || 0;
                document.getElementById('admImg').value = c.imagem || "";
            }
        });

        async function salvarTudo() {
            const sm = document.getElementById('admStockMarketing').value;
            const sr = document.getElementById('admStockReal').value;
            const p = document.getElementById('admPreco').value;
            const i = document.getElementById('admImg').value;
            await db.ref('configuracao').update({ 
                stockMarketing: parseInt(sm), 
                stockReal: parseInt(sr), 
                preco: parseInt(p), 
                imagem: i 
            });
            alert("‚úÖ Stocks e Pre√ßo Atualizados!");
        }

        // PEDIDOS
        document.getElementById('orderForm').onsubmit = async function(e) {
            e.preventDefault();
            const btn = document.getElementById('btnSubmit');
            btn.disabled = true;

            const pedido = {
                nome: document.getElementById('nome').value,
                contacto: document.getElementById('contacto').value,
                local: `${document.getElementById('bairro').value}, ${document.getElementById('provincia').value}`,
                horario: document.getElementById('horario').value,
                status: "Pendente",
                justificativa: "",
                diaSemana: new Date().getDay(),
                timestamp: 0 - Date.now()
            };

            try {
                await db.ref('pedidos').push(pedido);
                await db.ref('configuracao/stockReal').transaction(c => (c || 0) - 1);
                notifyTelegram(`üî• NOVO PEDIDO!\nCliente: ${pedido.nome}\nContacto: ${pedido.contacto}\nLocal: ${pedido.local}`);
                alert("RECEBIDO! Aguarde o nosso contacto.");
                this.reset();
            } catch (err) {}
            btn.disabled = false;
        };

        // GEST√ÉO ADMIN
        let windowChart = null;
        function carregarPedidos() {
            db.ref('pedidos').orderByChild('timestamp').on('value', snapshot => {
                const table = document.getElementById('adminTable');
                table.innerHTML = "";
                let faturamento = 0;
                let stats = { pendente: [0,0,0,0,0,0,0], confirmado: [0,0,0,0,0,0,0], entregue: [0,0,0,0,0,0,0], cancelado: [0,0,0,0,0,0,0] };

                const precoBase = parseInt(document.getElementById('admPreco').value) || 0;

                snapshot.forEach(child => {
                    const p = child.val();
                    const id = child.key;
                    const dia = p.diaSemana;
                    const st = p.status.toLowerCase();

                    if(stats[st]) stats[st][dia]++;
                    if(p.status === "Entregue") faturamento += precoBase;

                    let sClass = "status-" + st;
                    const copyText = `${p.nome} - ${p.contacto} - ${p.local}`;

                    table.innerHTML += `
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="p-5"><b>${p.nome}</b><br><span class="text-blue-600">${p.contacto}</span></td>
                            <td class="p-5 text-xs text-gray-500">${p.local}<br><b>${p.horario}</b></td>
                            <td class="p-5">
                                <button onclick="mudarStatus('${id}','${p.status}')" class="${sClass} w-full py-2 rounded-xl text-[9px] font-black uppercase tracking-widest shadow-sm">
                                    ${p.status}
                                </button>
                            </td>
                            <td class="p-5">
                                <input type="text" onchange="salvarJust('${id}', this.value)" value="${p.justificativa || ''}" 
                                    class="w-full bg-transparent border-b border-gray-100 text-[10px] outline-none" placeholder="...">
                            </td>
                            <td class="p-5 text-center flex gap-3 justify-center">
                                <button onclick="navigator.clipboard.writeText('${copyText}'); alert('Copiado!')" class="text-gray-300 hover:text-blue-500"><i class="fas fa-copy"></i></button>
                                <button onclick="apagar('${id}')" class="text-gray-200 hover:text-red-500"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                });
                document.getElementById('totalReceita').innerText = faturamento.toLocaleString() + " MT";
                renderizarGrafico(stats);
            });
        }

        function renderizarGrafico(stats) {
            const ctx = document.getElementById('vendasChart').getContext('2d');
            if(windowChart) windowChart.destroy();
            windowChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'],
                    datasets: [
                        { label: 'Entregue', data: stats.entregue, backgroundColor: '#3b82f6' },
                        { label: 'Caminho', data: stats.confirmado, backgroundColor: '#22c55e' },
                        { label: 'Novo', data: stats.pendente, backgroundColor: '#eab308' },
                        { label: 'Canc', data: stats.cancelado, backgroundColor: '#ef4444' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { stacked: true, grid: { display: false }, ticks: { size: 9, color: '#666' } }, y: { stacked: true, display: false } }
                }
            });
        }

        async function mudarStatus(id, s) {
            let ord = ["Pendente", "Confirmado", "Entregue", "Cancelado"];
            let next = ord[(ord.indexOf(s) + 1) % 4];
            await db.ref('pedidos/'+id).update({status: next});
        }
        async function salvarJust(id, v) { await db.ref('pedidos/'+id).update({justificativa: v}); }
        async function apagar(id) { if(confirm("Apagar?")) await db.ref('pedidos/'+id).remove(); }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('[id^="tab-"]').forEach(t => t.classList.remove('tab-active', 'text-[#39ff14]'));
            document.getElementById('content-' + tab).classList.add('active');
            document.getElementById('tab-' + tab).classList.add('tab-active');
        }

        function showAdmin() {
            if(prompt("Chave Master:") === "Lasanha") {
                document.getElementById('client-site').classList.add('admin-hidden');
                document.getElementById('admin-area').classList.remove('admin-hidden');
                carregarPedidos();
            }
        }
        function hideAdmin() {
            document.getElementById('client-site').classList.remove('admin-hidden');
            document.getElementById('admin-area').classList.add('admin-hidden');
        }
    </script>
</body>
</html>
